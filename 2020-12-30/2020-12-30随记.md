---
title: 2020-12-30随记
date: 2020-12-30 17:51:46
tags:
---

## 待办

2020-12-30 日,下午15点创建

### 问题

- 说明,安装 servlet3.0  再springboot 项目中引入Filter ,指定了urlPattern 拦截的url,但是经常会有未指定的url被拦截器拦截,例如:qp_new 项目中MemberLoginFilter 拦截了 TestController 类的方法
- redis 加载的不同的原因,探明,再未按照标准格式引入redis 的时候,经常会报连接异常,经查找发现 springboot 的redis 管理包,会默认通过 RedisConnectionFactory 对象来管理所以redis 连接;但是正常配置的好像不需要手动声明此类的创建,怀疑可能是正常配置后,springboot 会自动生成该类



### 完成度

- 1. 第一个问题,springboot 中配置 Servlet 3.0 注解配置(加上 @Component) Filter的问题,经测试发现,当使用这种方法配置的时候,springboot 加载时该 Filter 配置的 urlPattern 会统一变成 urlPattern = "/*", debug 路径:

     再某个filter 中断点 - > 进入 FilterChain 链接,找到被拦截的filter -> content -> filterMaps 是一个数组 ,可以找到该 Filter 对应的 拦截 url(这个对象总是包含当前上下文中注册的所有Filter 对象的 拦截 url 的键值对)

  2. 经过测试发现,单纯 @Component 注解就是将 类加载到 springboot 的上下文中,除了处理依赖关系 @Autowired等注解外,不会对其他参数进行处理,更不会处理 @WebFilter(Servlet3.0 的注解之类的定义);

     还是需要再启动类上加 @ServletComponentScan 注解来扫描项目中的 Servlet3.0 注解配置类,由这个注解来加载这些对象

  **说明**:(用时大约1个小时, **对比分析法**,通过上面描述的创建 过滤器 Filter, 和 通过 配置类中定义@Bean ,通过 FilterRegistrationBean 对象创建来加载Filter 两者进行对比来发现,难点就是查询 debug 对象,想看 哪个地方设置 Filter 和 拦截的url 的关系,找了很长时间)

- 1. 第二个问题,经过测试发现再按照 springboot 原本的配置项配置redis 的连接参数时,并未像我再qp_new 中自定义配置项,自定义加载到 springboot 中那样 ,没有进入 (org.springframework.boot.autoconfigure.data.redis.JedisConnectionConfiguration#redisConnectionFactory) 这个方法,该方法外有一个注解判断 @ConditionalOnMissingBean,如下,说明此时程序中已经存在了 RedisConnectionFactory 对象

     ```
     	// spring-boot-starter-data-redis 版本 2.2.5
     	@Bean
     	@ConditionalOnMissingBean(RedisConnectionFactory.class)
     	JedisConnectionFactory redisConnectionFactory(
     			ObjectProvider<JedisClientConfigurationBuilderCustomizer> builderCustomizers) throws UnknownHostException {
     		return createJedisConnectionFactory(builderCustomizers);
     	}
     ```

  2. 通过**引入分析法**(当发现一个类不知道是怎么创建的,且有很多实现的类的时候,我通常就再其他类中引入该类 @Autowired,通过debug 观察该类, this 对象就包含当前引入的对象), 发现按照springboot(springboot2.1.0版本) 自定义的方式配置 redis 配置 (他会自动去创建 LettuceConnectionFactory 另一种 redis 连接客户端,而不是 JedisConnectionFactory )

     过程:

     ```
     @Bean
     	@ConditionalOnMissingBean(RedisConnectionFactory.class)
     	public LettuceConnectionFactory redisConnectionFactory(
     			ClientResources clientResources) throws UnknownHostException {
     		LettuceClientConfiguration clientConfig = getLettuceClientConfiguration(
     				clientResources, this.properties.getLettuce().getPool());
     		return createLettuceConnectionFactory(clientConfig);
     	}
     ```

     同样是通过 @Configuration  和 @Bean 注解来自动装配 LettuceConnectionFactory 对象,通过 createLettuceConnectionFactory 方法来判断 redis 的类型是 集群的还是主从的还是单机的,然后通过

     ```
     org.springframework.boot.autoconfigure.data.redisRedisProperties //类来获取配置的配置
     
     @ConfigurationProperties(prefix = "spring.redis")
     public class RedisProperties {
     //...
     }
     ```

     该类通过@ConfigurationProperties 来加载配置文件的配置来构造加载到springboot 中

  **说明**:(主要是通过**对比分析**和**引入观察法**,来查找相关的类的创建过程和详情,来查找头绪,用时大约 半个小时 )

### 看过

比较有用的一些知识点

- 圈复杂度(关于重构)

- CAP 理论(分布式系统设计,参考[CAP理论](https://www.cnblogs.com/siyuanwai/p/14211166.html))

  